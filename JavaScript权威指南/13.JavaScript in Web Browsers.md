Web浏览器中的JavaScript
=======================

### 13.2 在HTML中嵌入JavaScript
* 当在页面中使用src嵌入一个外部的脚本文件，也就给了它（这个脚本文件）完全操控文档的权利。所以有的时候从第三方服务器加载脚本文件是有安全隐患的。
* 可以使用script标签嵌入任意的文本内容到页面文档中，主要给script声明一个不可被执行的类型就可以。比如 `<script id="template1" type="text/template">xxx</script>`，然后在代码中根据ID就可以找到这段标签中的内容了。
* 同时指定src和一个不被识别的类型时，脚本会被忽略并且不会从src地址指向的服务器下载任何内容。

### 13.3 JavaScript程序的执行

* JavaScript程序的执行分两个阶段。第一阶段，载入文档内容并执行`<script>`标签内的脚本，包括内联脚本和外部脚本。脚本通常会按它们在文档中出现的顺序执行。所有脚本都会从上往下，按照流程控制语言出现的顺序执行。
* 当文档载入完毕，全部脚本加载执行完毕，JavaScript执行就进入了它的第二阶段，这个阶段是异步的，而且由事件驱动的。事件驱动阶段里发生的第一个是load事件，表示文档已经载入并且可以操作了。
* 当HTML解析器碰到`<script>`标签时，它必须停下来先执行完脚本内容之后才会继续解析渲染接下来的文档内容。如果恰好是一个外部脚本，那就意味着在脚本下载、执行完毕之前，后面的文档内容都不会出现在浏览器中。
* defer和async属性告诉脚本可以在下载脚本的同时继续解析和渲染文档。
* 甚至可以在不支持defer/async的浏览器中动态创建`<script>`标签来加载脚本文件。
```
function loadJs(url){
    var script = document.createElement('script');
    script.src = url;
    var head = document.getElementByTagName('head')[0];
    head.appendChild(script);
}
```

JavaScript语言核心并不包括任何线程机制，客户端JavaScript也没有定义任何线程机制。HTML5定义了一种并发控制方式"Web Worker"，Web Worker是一个用来执行密集运算任务而不冻结用户操作界面的后台线程。不能和主线程或者其他worker共享状态，只能通过异步事件进行通信。

客户端JavaScript时间线：
1. Web浏览器创建Document对象，并且开始解析Web页面。在这个阶段document.readyState属性的值是"loading"。
2. 当HTML解析器遇到没有async和defer属性的`<script>`时，下载并且执行这个脚本，这时解析器会暂停。这样脚本就可以用document.write()来把文本插入到输入流中。解析器恢复时这些文本会成为文档的一部分。同步脚本可以看到它自己之前的文档内容。
3. 当解析器遇到async时，开始下载脚本并继续解析文档，脚本会在下载完之后尽快执行，但是解析器不会停下来等它。异步脚本禁止使用document.write()方法。
4. 当文档完成解析，document.readyState属性变成"interactive"。
5. 所有defer属性脚本会按照出现的顺序执行，异步脚本也可能在这个时候执行。延迟脚本能访问完整的文档树，禁止使用document.write()方法。
6. 浏览在在Document对象上触发DOMContentLoaded事件。这标志着程序执行从同步阶段转到了异步事件驱动阶段。但要注意这时候可能还有异步脚本没有执行完。
7. 文档全部解析完成，浏览器可能还在等待其他内容载入，如图片。当所有这些内容完成载入时，并且所有异步脚本完成载入和执行,document.readyState属性变成"complete"，Web浏览器触发Window对象上的load事件。
8. 从此刻起，会条用异步事件，以异步响应用户输入事件、网络事件、计时器过期等。

这是一条理想的时间线，但是所有浏览器都没有支持它的全部细节。什么时候文档开始对用户可见或什么时候Web浏览器必须开始响应用户输入事件，这都依赖浏览器的具体实现。对于很长的文档或者很慢的网络链接，Web浏览器理论上会渲染一部分文档，并且在所有脚本执行完毕之前就能允许用户开始页面进行一些交互。

### 13.4 兼容性

在IE6中增加了很多CSS标准特性，为了确保与已有Web内容的向后兼容性，它定义了两种不同的渲染模式。在"标准模式"或"CSS兼容模式"中，浏览器要遵循CSS标准，在"怪异模式"中，浏览器表现的和IE4和IE5中的怪异非标准模式一样。渲染模式的选择依赖于HTML文件顶部的DOCTYPE声明，在IE6中打开没有DOCTYPE的页面和声明了某些权限Doctype的页面都会按照怪异模式进行渲染。定义了HTML5 Doctype(`<!DOCTYPE html>`)的页面在所有现代浏览器中都会按照标准模式渲染。


### 13.6 安全性
* JavaScript不能做什么：
    * 很多浏览器限制了只有响应了用户的操作比如点击某个按钮，才能打开一个新的浏览器窗口。
    * JavaScript可以关闭自己打开的窗口，但是不允许它不经过用户确认就关闭其他的窗口。
    * 播放背景音频，具体限制条件类似打开新窗口。
    * HTML FileUpload的 `value` 属性是只读的，这是为了避免恶意脚本能够篡改上传文件。

* 同源策略
    * 源的定义： 协议 + 域名 + 端口号 + 地址（IE没有将不同的端口视为不同的源）。
    * 在脚本中可以通过设置 `document.domain = 'domain.com';` 来将当前子域名提升为超级域。从而可以访问该超级域名下的其他子域名资源。
    * 跨域访问可分为以下几类：跨域写入、跨域嵌入、跨域读取。
    * 跨域写入（比如 a链接，重定向，表单提交等）这个一般不会有限制。
    * 跨域嵌入资源比如 `<script src="..."> <link rel="stylesheet" href="...">, <img>, <audio>/<video>, <object>/<embed> ` 等等。这些一般也都不是没有限制的。
    * 跨域读取资源，一般会被禁止。（比如用script读取操作`<iframe>`中的其他域的document内容。）
    * CSRF标记（Cross-Site Request Forgery ）一般被用来阻止资源被跨站访问。

* 跨站脚本（XSS）
    * 最为重要是当页面需要呈现HTML动态内容，比如用户提交的文本内容时候。不要忘记过滤html标签尤其是<script>标签。

* 拒绝服务攻击
    * 网站代码不停执行一个非常耗时的操作，或者不断弹出alert窗口来占用CPU资源。不过除了恶意网站之外这样的站点一般不多见。
    
